# Traefik - Dynamic Configuration
# Middlewares, routers, and services

http:
  middlewares:
    # Authentik Forward Authentication
    authentik:
      forwardAuth:
        address: http://authentik-server:9000/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-entitlements
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

    # HTTP to HTTPS Redirect
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    # Rate Limiting
    ratelimit:
      rateLimit:
        average: 100
        period: 1s
        burst: 100

    # Security Headers (OWASP recommendations)
    security-headers:
      headers:
        customResponseHeaders:
          X-Robots-Tag: "all,noarchive,nosnippet,notranslate,noimageindex"
          Server: ""  # Hide server version
          X-Powered-By: ""  # Hide technology stack
          X-Forwarded-Proto: "https"
          Permissions-Policy: "accelerometer=(), autoplay=(), camera=(), display-capture=(), encrypted-media=(), fullscreen=(), gamepad=(), geolocation=(), gyroscope=(), hid=(), identity-credentials-get=(), idle-detection=(), local-fonts=(), magnetometer=(), microphone=(), midi=(), otp-credentials=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), serial=(), storage-access=(), usb=(), web-share=(), window-management=(), xr-spatial-tracking=()"
          Cross-Origin-Embedder-Policy: "unsafe-none"
          Cross-Origin-Opener-Policy: "same-origin"
          Cross-Origin-Resource-Policy: "same-site"
          X-Permitted-Cross-Domain-Policies: "none"
        sslProxyHeaders:
          X-Forwarded-Proto: "https"
        hostsProxyHeaders:
          - "X-Forwarded-Host"
        contentTypeNosniff: true
        referrerPolicy: "strict-origin-when-cross-origin"
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsSeconds: 63072000  # 2 years
        stsPreload: true

    # IP Whitelist (internal networks only)
    ip-whitelist:
      ipAllowList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"

    # Sablier - On-demand container scaling
    sablier:
      plugin:
        sablier:
          sablierUrl: http://sablier:10000
          group: default
          sessionDuration: 30m
          dynamic:
            displayName: "Starting service..."
            showDetails: true
            theme: hacker-terminal
            refreshFrequency: 5s

  # Example routers for non-Docker services
  routers:
    # Authentik outpost - handles SSO callbacks
    authentik-outpost:
      rule: "HostRegexp(`^.+\\.example\\.com$`) && PathPrefix(`/outpost.goauthentik.io/`)"
      entryPoints:
        - websecure
      service: authentik-outpost-service
      tls:
        certResolver: letsencrypt
      priority: 15

  services:
    authentik-outpost-service:
      loadBalancer:
        servers:
          - url: "http://authentik-server:9000"
        passHostHeader: true

  # Server Transports
  serversTransports:
    authentik-transport:
      # Enable HTTP/2 to backend - try with HTTP/2 since static assets need it
      disableHTTP2: false
      # Connection pool settings to prevent connection reuse issues
      maxIdleConnsPerHost: 10
      # Timeout settings that match Authentik's response times
      forwardingTimeouts:
        dialTimeout: 10s
        responseHeaderTimeout: 30s
        idleConnTimeout: 90s
